<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã„ãŒæ —ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ver1.0 - Webã‚«ãƒ¡ãƒ©ï¼†ä¿å­˜ãƒœã‚¿ãƒ³å¯¾å¿œ</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; margin: 0; }
    #authOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 9999;
      display: flex; justify-content: center; align-items: center;
      color: white; font-size: 1.2em;
      flex-direction: column;
    }
    input[type="password"] {
      font-size: 1.2em; padding: 10px; margin-top: 10px;
    }
    button { font-size: 1em; padding: 5px 10px; }
    canvas, video { width: 100%; height: auto; border: 1px solid #ccc; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 10px; word-break: break-word; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background-color: #f0f0f0; }
    .controls, .sliders { width: 90%; max-width: 600px; margin: 10px auto; text-align: left; }
    .sliders label { display: block; margin: 5px 0; }
    input[type="range"] { width: 100%; }
    .section { width: 90%; max-width: 800px; margin: 0 auto 30px; text-align: left; }
    .section h2 { font-size: 1.2em; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
    .section ul, .section ol { padding-left: 20px; }
    @media (max-width: 600px) {
      th, td { font-size: 0.8em; }
    }
  </style>
</head>
<body>
   <div id="authOverlay">
    <div>4æ¡ã®PINã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:</div>
    <input type="password" id="pinInput" maxlength="4" autofocus>
    <button onclick="checkPIN()">é–‹ã</button>
    <div id="authError" style="color: red; margin-top: 10px;"></div>
  </div>
  <h1>ã„ãŒæ —ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ver1.0ï¼ˆWebã‚«ãƒ¡ãƒ©ãƒ»ä¿å­˜ãƒœã‚¿ãƒ³å¯¾å¿œï¼‰</h1>


  <div class="section">
    <h2>âœ… å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½ä¸€è¦§</h2>
    <ul>
      <li>ğŸ“ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒã‹ã‚‰æ¤œå‡ºï¼‰</li>
      <li>ğŸ“· Webã‚«ãƒ¡ãƒ©å¯¾å¿œï¼ˆ3ç§’ã”ã¨è‡ªå‹•æ¤œå‡ºã€åœæ­¢ãƒœã‚¿ãƒ³ä»˜ãï¼‰</li>
      <li>ğŸ“Š ãƒ¢ãƒ‡ãƒ« Version åˆ‡æ›¿<ï¼ˆVersion 5ã€œ1 é¸æŠå¯èƒ½ï¼‰/li>
      <li>ğŸŒº ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ æ¤œå‡ºç²¾åº¦ / é‡ãªã‚Šåº¦ / â–¡é€æ˜åº¦ èª¿æ•´å¯èƒ½</li>
      <li>ğŸ–¼ æ¤œå‡ºæ•°ãƒ»å¹³å‡ã‚µã‚¤ã‚ºè¡¨ç¤º</li>
      <li>ğŸ“€ ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆJPGç”»åƒï¼‹CSVå‡ºåŠ›ï¼‰</li>
    </ul>
  </div>

  <div class="section">
    <h2>ğŸ—’ æ“ä½œèª¬æ˜</h2>
    <ol>
      <li>ã€Œãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã€ã§ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ è‡ªå‹•æ¤œå‡º</li>
      <li>ã€ŒWebã‚«ãƒ¡ãƒ©èµ·å‹•ã€ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œå‡ºï¼ˆ3ç§’é–“éš”ï¼‰</li>
      <li>æ¤œå‡ºå¾Œã«ã€ŒğŸ“€ çµæœã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ç”»åƒï¼‹CSVã‚’ä¿å­˜</li>
      <li>å„ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§æ¤œå‡ºç²¾åº¦ã‚„è¡¨ç¤ºâ–¡é€æ˜åº¦ã®èª¿æ•´ãŒå¯èƒ½</li>
      <li>ãƒ¢ãƒ‡ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§å¤‰æ›´å¯èƒ½ï¼ˆè‡ªå‹•å†æ¤œå‡ºï¼‰</li>
    </ol>
  </div>

  <div class="controls">
    <label>ãƒ¢ãƒ‡ãƒ« Version:
      <select id="versionSelect">
        <option value="5">5</option>
        <option value="4">4ï¼ˆæœ€æ–°ç‰ˆï¼‰</option>
        <option value="3">3</option>
        <option value="2">2</option>
        <option value="1">1</option>
      </select>
    </label>
    <label>ã‚«ãƒ¡ãƒ©é¸æŠ:
      <select id="cameraFacing">
        <option value="user">ã‚¤ãƒ³ã‚«ãƒ¡ãƒ©</option>
        <option value="environment" selected>ã‚¢ã‚¦ãƒˆã‚«ãƒ¡ãƒ©</option>
      </select>
    </label>
    <input type="file" accept="image/*" id="upload" />
    <button id="cameraBtn">ğŸ“· Webã‚«ãƒ¡ãƒ©èµ·å‹•</button>
    <button id="stopCameraBtn">ğŸ”´ Webã‚«ãƒ¡ãƒ©åœæ­¢</button>
    <button id="saveBtn">ğŸ“€ çµæœã‚’ä¿å­˜</button>
  </div>

  <div class="sliders">
    <label>æ¤œå‡ºç²¾åº¦: <span id="confidenceValue">50%</span>
      <input type="range" id="confidenceSlider" min="0" max="100" value="50">
    </label>
    <label>é‡ãªã‚Šåº¦: <span id="overlapValue">30%</span>
      <input type="range" id="overlapSlider" min="0" max="100" value="30">
    </label>
    <label>â–¡é€æ˜åº¦: <span id="opacityValue">80%</span>
      <input type="range" id="opacitySlider" min="0" max="100" value="80">
    </label>
  </div>

  <div id="count">æ¤œå‡ºæ•°ï¼š0å€‹</div>
  <canvas id="canvas"></canvas>
  <video id="video" autoplay playsinline></video>
  <div id="summary"></div>
  <div id="details"></div>

  <script>
    const PIN_CODE = "2638"; // ä»»æ„ã®4æ¡PINã«å¤‰æ›´å¯èƒ½
    function checkPIN() {
      const input = document.getElementById("pinInput").value;
      if (input === PIN_CODE) {
        document.getElementById("authOverlay").style.display = "none";
      } else {
        document.getElementById("authError").textContent = "PINãŒé–“é•ã£ã¦ã„ã¾ã™";
      }
    }
    const MODEL_ID = "iga-counter-j5otj";
    const API_KEY = "K4ZyTpkDTooa8A1ocuqh";

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const video = document.getElementById("video");
    const cameraBtn = document.getElementById("cameraBtn");
    const stopCameraBtn = document.getElementById("stopCameraBtn");
    const upload = document.getElementById("upload");
    const saveBtn = document.getElementById("saveBtn");
    const confidenceSlider = document.getElementById("confidenceSlider");
    const overlapSlider = document.getElementById("overlapSlider");
    const opacitySlider = document.getElementById("opacitySlider");
    const versionSelect = document.getElementById("versionSelect");
    const countDisplay = document.getElementById("count");
    const summaryDisplay = document.getElementById("summary");
    const detailsDisplay = document.getElementById("details");
    const cameraFacing = document.getElementById("cameraFacing");

    let currentImage = null;
    let lastPredictions = [];
    let cameraStream = null;
    let cameraInterval = null;

    function updateSliderDisplay() {
      document.getElementById("confidenceValue").textContent = `${confidenceSlider.value}%`;
      document.getElementById("overlapValue").textContent = `${overlapSlider.value}%`;
      document.getElementById("opacityValue").textContent = `${opacitySlider.value}%`;
    }

    confidenceSlider.oninput = () => {
      updateSliderDisplay();
      if (currentImage) detectImage(currentImage);
    };
    overlapSlider.oninput = () => {
      updateSliderDisplay();
      if (currentImage) detectImage(currentImage);
    };
    opacitySlider.oninput = updateSliderDisplay;
    versionSelect.onchange = () => {
      if (currentImage) detectImage(currentImage);
    };

    upload.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        currentImage = img;
        detectImage(img);
      };
      img.src = URL.createObjectURL(file);
    });

      async function detectImage(sourceCanvas) {
      const ctx = sourceCanvas.getContext("2d");
      ctx.fillStyle = "rgba(0, 255, 0, 0.2)";
      ctx.fillRect(10, 10, 100, 100);
      document.getElementById("count").textContent = "æ¤œå‡ºæ•°ï¼š1å€‹";
    }

      cameraBtn.addEventListener("click", async () => {
      try {
        const facingMode = cameraFacing.value;
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: facingMode } } });
        video.srcObject = cameraStream;
        video.style.display = "block";
        cameraInterval = setInterval(() => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          detectImage(canvas);
        }, 3000);
      } catch (err) {
        alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
      }
    });

    stopCameraBtn.addEventListener("click", () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        video.style.display = "none";
      }
      if (cameraInterval) clearInterval(cameraInterval);
    });

    saveBtn.addEventListener("click", () => {
      if (lastPredictions.length > 0) {
        downloadCanvasImage();
        downloadCSV(lastPredictions);
      }
    });

    async function detectImage(source) {
      const confidence = (confidenceSlider.value / 100).toFixed(2);
      const overlap = (overlapSlider.value / 100).toFixed(2);
      const opacity = opacitySlider.value / 100;
      const version = versionSelect.value;

      ctx.drawImage(source, 0, 0);
      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg", 0.9));
      const formData = new FormData();
      formData.append("file", blob, "image.jpg");

      countDisplay.textContent = "æ¤œå‡ºä¸­â€¦";
      summaryDisplay.textContent = "";
      detailsDisplay.innerHTML = "";

      try {
        const res = await fetch(`https://detect.roboflow.com/${MODEL_ID}/${version}?api_key=${API_KEY}&confidence=${confidence}&overlap=${overlap}`, {
          method: "POST",
          body: formData
        });
        const result = await res.json();
        const predictions = result.predictions || [];
        lastPredictions = predictions;

        countDisplay.textContent = `æ¤œå‡ºæ•°ï¼š${predictions.length}å€‹`;
        if (!predictions.length) return;

        let totalW = 0, totalH = 0;
        let table = "<table><tr><th>#</th><th>ã‚¯ãƒ©ã‚¹</th><th>ä¿¡é ¼åº¦</th><th>å¹…</th><th>é«˜ã•</th></tr>";
        predictions.forEach((pred, i) => {
          totalW += pred.width;
          totalH += pred.height;
          ctx.strokeStyle = "lime";
          ctx.lineWidth = 2;
          ctx.globalAlpha = opacity;
          ctx.strokeRect(pred.x - pred.width / 2, pred.y - pred.height / 2, pred.width, pred.height);
          ctx.globalAlpha = 1;
          ctx.fillStyle = "lime";
          ctx.font = "14px sans-serif";
          ctx.fillText(`${pred.class} (${(pred.confidence * 100).toFixed(1)}%)`, pred.x - pred.width / 2, pred.y - pred.height / 2 - 5);

          table += `<tr><td>${i + 1}</td><td>${pred.class}</td><td>${(pred.confidence * 100).toFixed(1)}%</td><td>${pred.width.toFixed(1)}</td><td>${pred.height.toFixed(1)}</td></tr>`;
        });
        table += "</table>";
        detailsDisplay.innerHTML = table;
        summaryDisplay.textContent = `å¹³å‡ã‚µã‚¤ã‚ºï¼šå¹… ${(totalW / predictions.length).toFixed(1)}px Ã— é«˜ã• ${(totalH / predictions.length).toFixed(1)}px`;

      } catch (err) {
        countDisplay.textContent = "æ¤œå‡ºå¤±æ•—: " + err.message;
      }
    }

    function downloadCanvasImage() {
      const timestamp = new Date().toISOString().replace(/[:T]/g, "-").split(".")[0];
      const link = document.createElement("a");
      link.download = `detection_result_${timestamp}.jpg`;
      link.href = canvas.toDataURL("image/jpeg");
      link.click();
    }

    let originalFileName = "(ã‚«ãƒ¡ãƒ©ç”»åƒ)"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«å

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨˜éŒ²
    upload.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      originalFileName = file.name; // å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨˜éŒ²
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        currentImage = img;
        detectImage(img);
      };
      img.src = URL.createObjectURL(file);
    });

    function downloadCSV(predictions) {
      const timestamp = new Date().toISOString().replace(/[:T]/g, "-").split(".")[0];
      const version = versionSelect.value;
      const confidence = `${confidenceSlider.value}%`;
      const overlap = `${overlapSlider.value}%`;
      const opacity = `${opacitySlider.value}%`;

      // ãƒ¡ã‚¿æƒ…å ±ã‚’å…ˆé ­ã«è¿½åŠ ï¼ˆæ—¥æœ¬èªè¡¨è¨˜ + ãƒ•ã‚¡ã‚¤ãƒ«åï¼‰
      const rows = [
        ["ä½œæˆæ—¥æ™‚", timestamp],
        ["å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«å", originalFileName],
        ["ãƒ¢ãƒ‡ãƒ« Version", version],
        ["æ¤œå‡ºç²¾åº¦", confidence],
        ["é‡ãªã‚Šåº¦", overlap],
        ["â–¡é€æ˜åº¦", opacity],
        ["æ¤œå‡ºå€‹æ•°", predictions.length],
        [],
        ["#", "ã‚¯ãƒ©ã‚¹", "æ¤œå‡ºç²¾åº¦", "å¹…", "é«˜ã•"]
      ];

      // æ¤œå‡ºçµæœã‚’CSVã«è¿½åŠ 
      predictions.forEach((p, i) => {
        rows.push([
          i + 1,
          p.class,
          (p.confidence * 100).toFixed(1),
          p.width.toFixed(1),
          p.height.toFixed(1)
        ]);
      });

      // CSVæ–‡å­—åˆ—ã«å¤‰æ›ï¼ˆShift-JIS + BOMä»˜ãï¼‰
      const csv = rows.map(r => r.join(",")).join("\r\n");
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=shift_jis;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `detection_result_${timestamp}.csv`;
      a.click();
    }
  </script>
</body>
</html>

